---
# Setting up a certificate authority
- name: "ensure {{ openvpn_easy_rsa_dir }}/easy-rsa exist"
  ansible.builtin.file: 
    path: "{{ openvpn_dir }}/easy-rsa"
    state: directory
    mode: "0755"

- name: create vars file
  copy:
    dest: "{{ openvpn_easy_rsa_dir }}/vars"
    content: |
      set_var EASYRSA_ALGO "ec"
      et_var EASYRSA_DIGEST "sha512"

- name: easy-rsa init-pki
  ansible.builtin.shell: "{{ openvpn_easy_rsa_dir }}/easyrsa init-pki"
  args:
    chdir: "{{ openvpn_dir }}/easy-rsa" 
    creates: "{{ openvpn_dir }}/easy-rsa/pki"

- name: easy-rsa build-ca nopass
  ansible.builtin.shell: "{{ openvpn_easy_rsa_dir }}/easyrsa build-ca nopass"
  args:
    chdir: "{{ openvpn_dir }}/easy-rsa" 
    creates: "{{ openvpn_dir }}/easy-rsa/pki/ca.crt"
  environment: 
    EASYRSA_BATCH: "yes"

- name: easy-rsa gen-dh
  ansible.builtin.shell: "{{ openvpn_easy_rsa_dir }}/easyrsa gen-dh"
  args:
    chdir: "{{ openvpn_dir }}/easy-rsa" 
    creates: "{{ openvpn_dir }}/easy-rsa/pki/dh.pem"

- name: easy-rsa server nopass
  ansible.builtin.shell: "echo yes | {{ openvpn_easy_rsa_dir }}/easyrsa build-server-full vpn-server nopass"
  args:
    chdir: "{{ openvpn_dir }}/easy-rsa"
    creates: "{{ openvpn_dir }}/easy-rsa/pki/issued/vpn-server.crt"

#- name: easy-rsa gen-crl nopass
#  ansible.builtin.shell: "{{ openvpn_easy_rsa_dir }}/easyrsa gen-crl"
#  args:
#    chdir: "{{ openvpn_dir }}/easy-rsa"
#    creates:  "{{ openvpn_dir }}/easy-rsa/pki/crl.pem"